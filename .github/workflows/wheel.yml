name: Python wheels

on:
 push:
   branches: [main]
   tags: ['v*.*.*']
 pull_request:
 workflow_dispatch:

jobs:
 build-wheels:
   name: Build wheels on ${{ matrix.os }}
   runs-on: ${{ matrix.os }}
   strategy:
     fail-fast: false
     matrix:
       os: [ubuntu-latest, macos-latest, windows-latest]

   steps:
     - name: Checkout
       uses: actions/checkout@v4
       with:
         fetch-depth: 0
         clean: true

     - name: Clean any prebuilt native libs in package
       shell: bash
       run: rm -f clients/python/tacozip/libtacozip.* clients/python/tacozip/tacozip.dll || true

     - name: Fix newlines for Apple Clang
       if: runner.os == 'macOS'
       run: |
         echo "" >> include/tacozip.h
         echo "" >> src/tacozip.c

     - name: Set up Python
       uses: actions/setup-python@v5
       with:
         python-version: '3.11'

     # Required for aarch64 Linux wheels on x86_64 runners
     - name: Set up QEMU (arm64)
       if: ${{ runner.os == 'Linux' }}
       uses: docker/setup-qemu-action@v3
       with:
         platforms: arm64

     - name: Verify arm64 container runs
       if: ${{ runner.os == 'Linux' }}
       run: docker run --rm --platform linux/arm64 quay.io/pypa/manylinux2014_aarch64:2025.04.19-1 uname -m

     - name: Install cibuildwheel
       shell: bash
       run: |
         python -m pip install --upgrade pip
         pip install 'cibuildwheel==2.*'

     - name: Build wheels with cibuildwheel
       shell: bash
       env:
         CIBW_BUILD: "cp39-* cp310-* cp311-* cp312-* cp313-*"
         CIBW_SKIP: "pp* *-win32 *-manylinux_i686"

         # ===== Linux =====
         CIBW_ARCHS_LINUX: "x86_64 aarch64"
         CIBW_MANYLINUX_X86_64_IMAGE: "manylinux2014"
         CIBW_MANYLINUX_AARCH64_IMAGE: "manylinux2014"
         CIBW_REPAIR_WHEEL_COMMAND_LINUX: "auditwheel repair -w {dest_dir} {wheel}"
         # Build minimal libzip from source using GitHub mirror
         CIBW_BEFORE_BUILD_LINUX: >
          python -m pip install cmake ninja &&
          wget --no-check-certificate https://github.com/nih-at/libzip/archive/refs/tags/v1.11.4.tar.gz -O libzip-1.11.4.tar.gz &&
          tar -xzf libzip-1.11.4.tar.gz &&
          cmake -S libzip-1.11.4 -B build-libzip
          -DCMAKE_INSTALL_PREFIX="/usr/local"
          -DCMAKE_BUILD_TYPE=Release
          -DBUILD_SHARED_LIBS=ON
          -DENABLE_COMMONCRYPTO=OFF
          -DENABLE_GNUTLS=OFF
          -DENABLE_MBEDTLS=OFF
          -DENABLE_OPENSSL=OFF
          -DENABLE_WINDOWS_CRYPTO=OFF
          -DENABLE_BZIP2=OFF
          -DENABLE_LZMA=OFF
          -DENABLE_ZSTD=OFF
          -DBUILD_TOOLS=OFF
          -DBUILD_REGRESS=OFF
          -DBUILD_EXAMPLES=OFF
          -DBUILD_DOC=OFF &&
          cmake --build build-libzip -j &&
          cmake --install build-libzip &&
          python {package}/prebuild.py

         # ===== macOS (universal2) =====
         CIBW_ARCHS_MACOS: "universal2"
         CIBW_ENVIRONMENT_MACOS: |
          MACOSX_DEPLOYMENT_TARGET=11.0
         CIBW_REPAIR_WHEEL_COMMAND_MACOS: |
          bash -exc "python -m pip install delocate && delocate-wheel --require-archs {delocate_archs} -w {dest_dir} -v {wheel}"
         # Build minimal libzip from source for macOS universal2 using GitHub
         CIBW_BEFORE_BUILD_MACOS: >
          python -m pip install cmake ninja &&
          curl -L https://github.com/nih-at/libzip/archive/refs/tags/v1.11.4.tar.gz -o libzip-1.11.4.tar.gz &&
          tar -xzf libzip-1.11.4.tar.gz &&
          cmake -S libzip-1.11.4 -B build-libzip
          -DCMAKE_INSTALL_PREFIX="/usr/local"
          -DCMAKE_BUILD_TYPE=Release
          -DBUILD_SHARED_LIBS=ON
          -DCMAKE_OSX_DEPLOYMENT_TARGET=11.0
          -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64"
          -DENABLE_COMMONCRYPTO=OFF
          -DENABLE_GNUTLS=OFF
          -DENABLE_MBEDTLS=OFF
          -DENABLE_OPENSSL=OFF
          -DENABLE_WINDOWS_CRYPTO=OFF
          -DENABLE_BZIP2=OFF
          -DENABLE_LZMA=OFF
          -DENABLE_ZSTD=OFF
          -DBUILD_TOOLS=OFF
          -DBUILD_REGRESS=OFF
          -DBUILD_EXAMPLES=OFF
          -DBUILD_DOC=OFF &&
          cmake --build build-libzip -j &&
          sudo cmake --install build-libzip &&
          python {package}/prebuild.py

         # ===== Windows =====
         CIBW_ARCHS_WINDOWS: "AMD64"
         
         # Build zlib and minimal libzip from source for Windows using GitHub
         CIBW_BEFORE_BUILD_WINDOWS: >
          python -m pip install cmake ninja &&
          curl -L https://github.com/madler/zlib/archive/refs/tags/v1.3.1.zip -o zlib-1.3.1.zip &&
          powershell -Command "Expand-Archive zlib-1.3.1.zip -DestinationPath ." &&
          cmake -S zlib-1.3.1 -B build-zlib -DCMAKE_INSTALL_PREFIX="C:/deps" -DBUILD_SHARED_LIBS=ON &&
          cmake --build build-zlib --config Release &&
          cmake --install build-zlib &&
          curl -L https://github.com/nih-at/libzip/archive/refs/tags/v1.11.4.zip -o libzip-1.11.4.zip &&
          powershell -Command "Expand-Archive libzip-1.11.4.zip -DestinationPath ." &&
          cmake -S libzip-1.11.4 -B build-libzip
          -DCMAKE_INSTALL_PREFIX="C:/deps"
          -DCMAKE_BUILD_TYPE=Release
          -DBUILD_SHARED_LIBS=ON
          -DCMAKE_PREFIX_PATH="C:/deps"
          -DENABLE_COMMONCRYPTO=OFF
          -DENABLE_GNUTLS=OFF
          -DENABLE_MBEDTLS=OFF
          -DENABLE_OPENSSL=OFF
          -DENABLE_WINDOWS_CRYPTO=OFF
          -DENABLE_BZIP2=OFF
          -DENABLE_LZMA=OFF
          -DENABLE_ZSTD=OFF
          -DBUILD_TOOLS=OFF
          -DBUILD_REGRESS=OFF
          -DBUILD_EXAMPLES=OFF
          -DBUILD_DOC=OFF &&
          cmake --build build-libzip --config Release &&
          cmake --install build-libzip &&
          python {package}/prebuild.py

         # Test command bypasses __main__.py issue
         CIBW_TEST_COMMAND: python -c "import tacozip; tacozip.self_check(); print('tacozip test passed')"
       run: |
         echo "Package contents before wheel build (native lib will be created inside cibuildwheel env):"
         ls -l clients/python/tacozip || true

         cibuildwheel clients/python --output-dir wheelhouse

         echo "Wheels produced:"
         ls -l wheelhouse

     - name: Upload wheels (artifact)
       uses: actions/upload-artifact@v4
       with:
         name: wheels-${{ matrix.os }}
         path: wheelhouse/*.whl

 publish:
   name: Publish to PyPI (on tag)
   needs: build-wheels
   runs-on: ubuntu-latest
   if: startsWith(github.ref, 'refs/tags/v')
   steps:
     - name: Download built wheels
       uses: actions/download-artifact@v4
       with:
         path: dist
         pattern: wheels-*
         merge-multiple: true

     - name: List artifacts to publish
       shell: bash
       run: |
         echo "Files in dist/:"
         ls -l dist || true
         echo "Wheel files:"
         find dist -type f -name '*.whl' -print || true

     - name: Publish to PyPI
       uses: pypa/gh-action-pypi-publish@v1.12.4
       with:
         packages_dir: dist
         user: __token__
         password: ${{ secrets.PYPI_API_TOKEN }}
         skip-existing: true
         verbose: true